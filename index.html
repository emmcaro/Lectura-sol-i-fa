<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Tutor - Lector de notes</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-color: #1a1a2e;
  --container-bg: #2c2f33;
  --primary-color: #bb86fc;
  --button-color: #E83F89;
  --text-color: #f0f0f0;
  --secondary-text-color: #a0a0a0;
  --correct-color: #4CAF50;
  --incorrect-color: #F44336;
}

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  text-align: center;
}

.container {
  background-color: var(--container-bg);
  padding: 2.5rem;
  border-radius: 1rem;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
  max-width: 90vw;
  width: 550px;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

h1 {
  color: var(--primary-color);
  font-size: 2rem;
  margin: 0;
  font-weight: 700;
}

.header-stats {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
  color: var(--secondary-text-color);
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#difficulty-screen { display: flex; flex-direction: column; gap: 1.5rem; text-align: center; }
#difficulty-buttons { display: flex; justify-content: center; gap: 1rem; }

.difficulty-button, .note-button, #next-button, .play-again-button {
  border: none; border-radius: 9999px; cursor: pointer; font-weight: 600;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background-color 0.3s, transform 0.1s;
}

.difficulty-button { background: var(--primary-color); color: var(--bg-color); padding: 0.75rem 1.25rem; font-size: 1rem; }
.difficulty-button:hover { background: #9b59b6; transform: translateY(-2px); }

#game-content { display: flex; flex-direction: column; gap: 1.5rem; }
#final-score { display: none; flex-direction: column; gap: 1rem; font-size: 1.5rem; font-weight: bold; }

canvas {
  background-color: white;
  border: 2px solid var(--text-color);
  border-radius: 0.5rem;
  width: 100%;
  height: auto;
  max-height: 400px;
}

#controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
.note-button { background: var(--button-color); color: var(--bg-color); padding: 0.75rem 1.25rem; font-size: 1.25rem; min-width: 60px; }
.note-button:hover { background: #c72b6b; transform: translateY(-2px); }
.note-button:active { transform: translateY(0); }

#feedback-area { height: 2rem; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; }
#next-button { background: var(--button-color); color: var(--bg-color); padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 9999px; cursor: pointer; font-weight: 600; }
#next-button:hover { background-color: #c72b6b; transform: translateY(-2px); }

.play-again-button { background: var(--primary-color); color: var(--bg-color); padding: 0.75rem 1.5rem; font-size: 1rem; margin-top:1rem; }
.play-again-button:hover { background-color: #9b59b6; transform: translateY(-2px); }

.hidden { display: none; }
</style>
</head>
<body>
<div class="container">
  <div id="difficulty-screen">
    <h1>Lectura de notes</h1>
    <div id="difficulty-buttons">
      <button class="difficulty-button" data-level="easy">F√†cil</button>
      <button class="difficulty-button" data-level="normal">Normal</button>
      <button class="difficulty-button" data-level="hard">Dif√≠cil</button>
    </div>
  </div>

  <div id="game-content" class="hidden">
    <div class="header-stats">
      <div>Punts: <span id="score">0</span> / <span id="totalQuestions">0</span></div>
    </div>
    <canvas id="staffCanvas" width="500" height="400"></canvas>
    <div id="controls">
      <button class="note-button" data-note="C">C</button>
      <button class="note-button" data-note="D">D</button>
      <button class="note-button" data-note="E">E</button>
      <button class="note-button" data-note="F">F</button>
      <button class="note-button" data-note="G">G</button>
      <button class="note-button" data-note="A">A</button>
      <button class="note-button" data-note="B">B</button>
    </div>
    <div id="feedback-area"></div>
    <button id="next-button" class="hidden">Seg√ºent Repte</button>
  </div>

  <div id="final-score" class="hidden">
    <h2>Exercici completat!</h2>
    <p>La teva puntuaci√≥ final √©s:</p>
    <p><span id="finalScoreDisplay"></span></p>
    <button class="play-again-button">Torna a jugar</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('staffCanvas');
  const ctx = canvas.getContext('2d');
  const noteButtons = document.querySelectorAll('.note-button');
  const feedbackArea = document.getElementById('feedback-area');
  const scoreDisplay = document.getElementById('score');
  const totalQuestionsDisplay = document.getElementById('totalQuestions');
  const nextButton = document.getElementById('next-button');
  const difficultyButtons = document.querySelectorAll('.difficulty-button');
  const difficultyScreen = document.getElementById('difficulty-screen');
  const gameContent = document.getElementById('game-content');
  const finalScoreScreen = document.getElementById('final-score');
  const finalScoreDisplay = document.getElementById('finalScoreDisplay');
  const playAgainButton = document.querySelector('.play-again-button');

  const lineHeight = 20;
  const staffTopY_TREBLE = 60;
  const staffTopY_BASS = 220; // m√©s separat del pentagrama de Sol
  const MAX_QUESTIONS = 10;
  const staffColor = '#333';

  let score = 0;
  let totalQuestions = 0;
  let currentNote = null;
  let currentFullNote = null;
  let currentNotes = {};

  const rootStyles = getComputedStyle(document.documentElement);
  const correctColor = rootStyles.getPropertyValue('--correct-color');
  const incorrectColor = rootStyles.getPropertyValue('--incorrect-color');

  const DIFFICULTY_NOTES = {
    easy: {
      // Clau de sol
      'C4': { y: staffTopY_TREBLE + lineHeight*5, clef: "treble" },
      'D4': { y: staffTopY_TREBLE + lineHeight*4.5, clef: "treble" },
      'E4': { y: staffTopY_TREBLE + lineHeight*4, clef: "treble" },
      'F4': { y: staffTopY_TREBLE + lineHeight*3.5, clef: "treble" },
      'G4': { y: staffTopY_TREBLE + lineHeight*3, clef: "treble" },

      // Clau de fa
      'E2': { y: staffTopY_BASS + lineHeight*5, clef: "bass" },
      'F2': { y: staffTopY_BASS + lineHeight*4.5, clef: "bass" },
      'G2': { y: staffTopY_BASS + lineHeight*4, clef: "bass" },
      'A2': { y: staffTopY_BASS + lineHeight*3.5, clef: "bass" },
      'B2': { y: staffTopY_BASS + lineHeight*3, clef: "bass" }
    }
  };

  function drawStaff(yTop, clef="treble") {
    ctx.strokeStyle = staffColor;
    ctx.lineWidth = 2;
    for (let i=0;i<5;i++){
      const y=yTop+i*lineHeight;
      ctx.beginPath();
      ctx.moveTo(30,y);
      ctx.lineTo(canvas.width-30,y);
      ctx.stroke();
    }

    if(clef==="treble"){
      ctx.font='170px Arial';
      ctx.fillStyle=staffColor;
      ctx.fillText('ùÑû',40,yTop+lineHeight*4.7);
    } else if(clef==="bass"){
      ctx.save();
      ctx.font='112px Arial'; // 42% m√©s petita
      ctx.fillStyle=staffColor;
      ctx.fillText('ùÑ¢',45,yTop+lineHeight*3.5);
      ctx.restore();
    }
  }

  function drawNote(noteY, clefTop){
    const noteX = canvas.width/2;
    ctx.fillStyle = staffColor;
    ctx.beginPath();
    ctx.ellipse(noteX,noteY,15,12,-Math.PI/16,0,2*Math.PI);
    ctx.fill();

    ctx.strokeStyle = staffColor;
    ctx.lineWidth = 2;
    ctx.beginPath();
    if(noteY > clefTop+lineHeight*2.5) ctx.moveTo(noteX+15,noteY),ctx.lineTo(noteX+15,noteY-60);
    else ctx.moveTo(noteX-15,noteY),ctx.lineTo(noteX-15,noteY+60);
    ctx.stroke();

    const ledgerWidth=50, ledgerThickness=2;
    const lowestY = clefTop+4*lineHeight;
    const highestY = clefTop;

    if(noteY>lowestY){
      let lineY=lowestY+lineHeight;
      while(lineY<=noteY+1){
        ctx.beginPath();
        ctx.strokeStyle=staffColor;
        ctx.lineWidth=ledgerThickness;
        ctx.moveTo(noteX-ledgerWidth/2,lineY);
        ctx.lineTo(noteX+ledgerWidth/2,lineY);
        ctx.stroke();
        lineY+=lineHeight;
      }
    }

    if(noteY<highestY){
      let lineY=highestY-lineHeight;
      while(lineY>=noteY-1){
        ctx.beginPath();
        ctx.strokeStyle=staffColor;
        ctx.lineWidth=ledgerThickness;
        ctx.moveTo(noteX-ledgerWidth/2,lineY);
        ctx.lineTo(noteX+ledgerWidth/2,lineY);
        ctx.stroke();
        lineY-=lineHeight;
      }
    }
  }

  function generateNewNote(){
    if(totalQuestions>=MAX_QUESTIONS){ endGame(); return; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawStaff(staffTopY_TREBLE,"treble");
    drawStaff(staffTopY_BASS,"bass");

    const noteNames=Object.keys(currentNotes);
    const randomNote=noteNames[Math.floor(Math.random()*noteNames.length)];
    currentFullNote=randomNote;
    currentNote=randomNote[0];
    const data=currentNotes[randomNote];
    drawNote(data.y, data.clef==="treble"?staffTopY_TREBLE:staffTopY_BASS);

    feedbackArea.textContent='';
    nextButton.classList.add('hidden');
    noteButtons.forEach(b=>b.disabled=false);
    totalQuestions++;
    totalQuestionsDisplay.textContent=totalQuestions;
  }

  function checkAnswer(sel){
    if(sel===currentNote){
      score++;
      feedbackArea.textContent="Correcte";
      feedbackArea.style.color=correctColor;
    } else {
      feedbackArea.textContent="Incorrecte";
      feedbackArea.style.color=incorrectColor;
    }
    scoreDisplay.textContent=score;
    noteButtons.forEach(b=>b.disabled=true);
    if(totalQuestions<MAX_QUESTIONS) nextButton.classList.remove('hidden');
  }

  function startGame(level){
    currentNotes=DIFFICULTY_NOTES[level];
    difficultyScreen.classList.add('hidden');
    gameContent.classList.remove('hidden');
    score=0; totalQuestions=0;
    scoreDisplay.textContent=score;
    totalQuestionsDisplay.textContent=totalQuestions;
    generateNewNote();
  }

  function endGame(){
    gameContent.classList.add('hidden');
    finalScoreScreen.classList.remove('hidden');
    finalScoreDisplay.textContent=`${score} / ${MAX_QUESTIONS}`;
  }

  function resetGame(){
    finalScoreScreen.classList.add('hidden');
    difficultyScreen.classList.remove('hidden');
  }

  difficultyButtons.forEach(b=>b.addEventListener('click',()=>startGame(b.dataset.level)));
  noteButtons.forEach(b=>b.addEventListener('click',()=>checkAnswer(b.dataset.note)));
  nextButton.addEventListener('click',generateNewNote);
  playAgainButton.addEventListener('click',resetGame);
});
</script>
</body>
</html>
