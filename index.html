<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Tutor - Doble pentagrama</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-color: #1a1a2e;
    --container-bg: #2c2f33;
    --primary-color: #bb86fc;
    --button-color: #E83F89;
    --text-color: #f0f0f0;
    --secondary-text-color: #a0a0a0;
    --correct-color: #4CAF50;
    --incorrect-color: #F44336;
}
body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    text-align: center;
}
.container {
    background-color: var(--container-bg);
    padding: 2.5rem;
    border-radius: 1rem;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
    max-width: 90vw;
    width: 500px;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}
h1 { color: var(--primary-color); font-size: 2rem; margin: 0; font-weight: 700; }
.header-stats { display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--secondary-text-color); padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
#difficulty-screen { display: flex; flex-direction: column; gap:1.5rem; text-align:center; }
#difficulty-buttons { display:flex; justify-content:center; gap:1rem; }
.difficulty-button { background-color:var(--primary-color); color:var(--bg-color); border:none; padding:0.75rem 1.25rem; font-size:1rem; border-radius:9999px; cursor:pointer; font-weight:600; }
.difficulty-button:hover { background-color:#9b59b6; transform:translateY(-2px); }
#game-content { display:flex; flex-direction:column; gap:1.5rem; }
canvas { background-color:white; border:2px solid var(--text-color); border-radius:0.5rem; width:100%; height:auto; max-height:350px; }
#controls { display:flex; flex-wrap:wrap; justify-content:center; gap:0.5rem; }
.note-button { background-color:var(--button-color); color:var(--bg-color); border:none; padding:0.75rem 1.25rem; font-size:1.25rem; border-radius:9999px; cursor:pointer; min-width:60px; font-weight:600; }
.note-button:hover { background-color:#c72b6b; transform:translateY(-2px); }
#feedback-area { height:2rem; display:flex; align-items:center; justify-content:center; font-size:1.2rem; font-weight:bold; }
#next-button { background-color:var(--button-color); color:var(--bg-color); border:none; padding:0.75rem 1.5rem; font-size:1rem; border-radius:9999px; cursor:pointer; font-weight:600; }
.play-again-button { background-color:var(--primary-color); color:var(--bg-color); border:none; padding:0.75rem 1.5rem; font-size:1rem; border-radius:9999px; cursor:pointer; font-weight:600; margin-top:1rem; }
.hidden { display:none; }
</style>
</head>
<body>
<div class="container">
    <div id="difficulty-screen">
        <h1>Lectura de notes</h1>
        <p>Quantes notes vols que apareguin en cada exercici?</p>
        <div id="difficulty-buttons">
            <button class="difficulty-button" data-level="2">2 notes</button>
            <button class="difficulty-button" data-level="4">4 notes</button>
            <button class="difficulty-button" data-level="6">6 notes</button>
        </div>
    </div>
    <div id="game-content" class="hidden">
        <div class="header-stats">
            <div>Punts: <span id="score">0</span> / <span id="totalQuestions">0</span></div>
        </div>
        <canvas id="staffCanvas" width="500" height="350"></canvas>
        <div id="controls">
            <button class="note-button" data-note="C">C</button>
            <button class="note-button" data-note="D">D</button>
            <button class="note-button" data-note="E">E</button>
            <button class="note-button" data-note="F">F</button>
            <button class="note-button" data-note="G">G</button>
            <button class="note-button" data-note="A">A</button>
            <button class="note-button" data-note="B">B</button>
        </div>
        <div id="feedback-area"></div>
        <button id="next-button" class="hidden">Seg√ºent Repte</button>
    </div>
    <div id="final-score" class="hidden">
        <h2>Exercici completat!</h2>
        <p>La teva puntuaci√≥ final √©s:</p>
        <p><span id="finalScoreDisplay"></span></p>
        <button class="play-again-button">Torna a jugar</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('staffCanvas');
    const ctx = canvas.getContext('2d');
    const noteButtons = document.querySelectorAll('.note-button');
    const feedbackArea = document.getElementById('feedback-area');
    const scoreDisplay = document.getElementById('score');
    const totalQuestionsDisplay = document.getElementById('totalQuestions');
    const nextButton = document.getElementById('next-button');
    const difficultyButtons = document.querySelectorAll('.difficulty-button');
    const difficultyScreen = document.getElementById('difficulty-screen');
    const gameContent = document.getElementById('game-content');
    const finalScoreScreen = document.getElementById('final-score');
    const finalScoreDisplay = document.getElementById('finalScoreDisplay');
    const playAgainButton = document.querySelector('.play-again-button');

    const lineHeight = 20;
    const staffTopY_Treble = 60;
    const staffTopY_Bass = staffTopY_Treble + 5 * lineHeight + 50; 
    const MAX_QUESTIONS = 10;

    let score = 0;
    let totalQuestions = 0;
    let currentNotes = [];
    let noteIndex = 0;
    let currentDifficulty;

    const rootStyles = getComputedStyle(document.documentElement);
    const correctColor = rootStyles.getPropertyValue('--correct-color');
    const incorrectColor = rootStyles.getPropertyValue('--incorrect-color');
    const staffColor = '#333';

    // IMPORTANT: Notes and their accurate vertical positions.
    const NOTE_MAPPING = {
        treble: {
            "E4": staffTopY_Treble + lineHeight * 4,
            "F4": staffTopY_Treble + lineHeight * 3.5,
            "G4": staffTopY_Treble + lineHeight * 3,
            "A4": staffTopY_Treble + lineHeight * 2.5,
            "B4": staffTopY_Treble + lineHeight * 2,
            "C5": staffTopY_Treble + lineHeight * 1.5,
            "D5": staffTopY_Treble + lineHeight * 1,
            "E5": staffTopY_Treble + lineHeight * 0.5,
            "F5": staffTopY_Treble,
            "G5": staffTopY_Treble - lineHeight * 0.5,
            "A5": staffTopY_Treble - lineHeight * 1,
            "B5": staffTopY_Treble - lineHeight * 1.5,
        },
        bass: {
            "E2": staffTopY_Bass + lineHeight * 5,
            "F2": staffTopY_Bass + lineHeight * 4.5,
            "G2": staffTopY_Bass + lineHeight * 4,
            "A2": staffTopY_Bass + lineHeight * 3.5,
            "B2": staffTopY_Bass + lineHeight * 3,
            "C3": staffTopY_Bass + lineHeight * 2.5,
            "D3": staffTopY_Bass + lineHeight * 2,
            "E3": staffTopY_Bass + lineHeight * 1.5,
            "F3": staffTopY_Bass + lineHeight * 1,
            "G3": staffTopY_Bass + lineHeight * 0.5,
            "A3": staffTopY_Bass,
            "C2": staffTopY_Bass + lineHeight * 6,
        }
    };

    const NOTE_POOL = {
        treble: Object.keys(NOTE_MAPPING.treble),
        bass: Object.keys(NOTE_MAPPING.bass)
    };
    
    // Global array with all notes sorted by position (low to high)
    const allNotesGlobal = [
        ...NOTE_POOL.treble.map(n => ({ fullNote: n, clef: 'treble' })),
        ...NOTE_POOL.bass.map(n => ({ fullNote: n, clef: 'bass' }))
    ].sort((a, b) => {
        const aPos = NOTE_MAPPING[a.clef][a.fullNote];
        const bPos = NOTE_MAPPING[b.clef][b.fullNote];
        if (a.clef === 'treble' && b.clef === 'bass') return -1;
        if (a.clef === 'bass' && b.clef === 'treble') return 1;
        return aPos - bPos;
    });

    // Helper function to get the position index of a note in the global sorted list
    function getNoteIndex(note) {
        return allNotesGlobal.findIndex(n => n.fullNote === note.fullNote && n.clef === note.clef);
    }
    
    // Funci√≥ per reproduir un so
    function playSound(filename) {
        const audio = new Audio(`sounds/${filename}`);
        audio.play().catch(e => console.error("Error al reproduir el so:", e));
    }
    
    function drawStaff() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = staffColor;
        ctx.lineWidth = 2;

        for (let i = 0; i < 5; i++) {
            const y = staffTopY_Treble + i * lineHeight;
            ctx.beginPath();
            ctx.moveTo(30, y);
            ctx.lineTo(canvas.width - 30, y);
            ctx.stroke();
        }
        ctx.font = '209px Arial';
        ctx.fillStyle = staffColor;
        ctx.fillText('ùÑû', 40, staffTopY_Treble + lineHeight * 4.7);

        for (let i = 0; i < 5; i++) {
            const y = staffTopY_Bass + i * lineHeight;
            ctx.beginPath();
            ctx.moveTo(30, y);
            ctx.lineTo(canvas.width - 30, y);
            ctx.stroke();
        }
        ctx.font = '133px Arial';
        ctx.fillText('ùÑ¢', 40, staffTopY_Bass + lineHeight * 4.7);
    }
    
    function drawWholeNote(x, y, clef) {
        ctx.beginPath();
        const radiusX = 18;
        const radiusY = 10;
        const rotationAngle = -Math.PI / 10; 
        ctx.ellipse(x, y, radiusX, radiusY, rotationAngle, 0, 2 * Math.PI);
        ctx.strokeStyle = staffColor;
        ctx.lineWidth = 4;
        ctx.stroke();
        
        const lineOffset = 8;
        ctx.lineWidth = 3;

        const lowestStaffLineTreble = staffTopY_Treble + lineHeight * 4; 
        const highestStaffLineTreble = staffTopY_Treble;                 
        const lowestStaffLineBass = staffTopY_Bass + lineHeight * 4;     
        const highestStaffLineBass = staffTopY_Bass;                     
        
        if (clef === 'treble') {
            if (y > lowestStaffLineTreble) {
                for (let currentY = lowestStaffLineTreble + lineHeight; currentY <= y; currentY += lineHeight) {
                    ctx.beginPath();
                    ctx.moveTo(x - radiusX - lineOffset, currentY);
                    ctx.lineTo(x + radiusX + lineOffset, currentY);
                    ctx.stroke();
                }
            } else if (y < highestStaffLineTreble) {
                for (let currentY = highestStaffLineTreble; currentY >= y; currentY -= lineHeight) {
                    if (currentY < highestStaffLineTreble) {
                        ctx.beginPath();
                        ctx.moveTo(x - radiusX - lineOffset, currentY);
                        ctx.lineTo(x + radiusX + lineOffset, currentY);
                        ctx.stroke();
                    }
                }
            }
        } else { // Bass clef
            if (y > lowestStaffLineBass) {
                for (let currentY = lowestStaffLineBass + lineHeight; currentY <= y; currentY += lineHeight) {
                    ctx.beginPath();
                    ctx.moveTo(x - radiusX - lineOffset, currentY);
                    ctx.lineTo(x + radiusX + lineOffset, currentY);
                    ctx.stroke();
                }
            } else if (y < highestStaffLineBass) {
                for (let currentY = highestStaffLineBass; currentY >= y; currentY -= lineHeight) {
                    if (currentY < highestStaffLineBass) {
                        ctx.beginPath();
                        ctx.moveTo(x - radiusX - lineOffset, currentY);
                        ctx.lineTo(x + radiusX + lineOffset, currentY);
                        ctx.stroke();
                    }
                }
            }
        }
    }
    
    // Funci√≥ per verificar si hi ha una seq√º√®ncia de 3 notes consecutives
    function hasConsecutiveNotes(notes) {
        if (notes.length < 3) return false;
        
        let sortedNotes = [...notes].sort((a,b) => getNoteIndex(a) - getNoteIndex(b));
        
        for (let i = 0; i <= sortedNotes.length - 3; i++) {
            const idx1 = getNoteIndex(sortedNotes[i]);
            const idx2 = getNoteIndex(sortedNotes[i+1]);
            const idx3 = getNoteIndex(sortedNotes[i+2]);
            if (Math.abs(idx2 - idx1) === 1 && Math.abs(idx3 - idx2) === 1) {
                return true;
            }
        }
        return false;
    }

    // Dibuixa les notes amb la l√≤gica de despla√ßament
    function drawNotes(notes) {
        drawStaff();
        const xPos = canvas.width / 2;
        
        let hasConsecutive = hasConsecutiveNotes(notes);
        let consecutiveNoteIndex = -1;

        if(hasConsecutive){
            let sortedNotes = [...notes].sort((a,b) => getNoteIndex(a) - getNoteIndex(b));
            for(let i = 0; i <= sortedNotes.length - 3; i++){
                const idx1 = getNoteIndex(sortedNotes[i]);
                const idx2 = getNoteIndex(sortedNotes[i+1]);
                const idx3 = getNoteIndex(sortedNotes[i+2]);
                if (Math.abs(idx2 - idx1) === 1 && Math.abs(idx3 - idx2) === 1) {
                    consecutiveNoteIndex = getNoteIndex(sortedNotes[i+1]);
                    break;
                }
            }
        }

        let previousY = null;

        notes.forEach(note => {
            const yPos = NOTE_MAPPING[note.clef][note.fullNote];
            let currentX = xPos;
            const currentNoteIndex = getNoteIndex(note);
            
            // Dibuixa el despla√ßament si √©s la nota del mig de la seq√º√®ncia
            if (hasConsecutive && currentNoteIndex === consecutiveNoteIndex) {
                 currentX += 30; // Despla√ßament a la dreta
            } else if (previousY !== null && Math.abs(yPos - previousY) === lineHeight / 2) {
                currentX += 31;
            }
            
            drawWholeNote(currentX, yPos, note.clef);
            previousY = yPos;
        });
    }

    function generateQuestion(numNotes) {
        currentDifficulty = numNotes;
        let validNotes = false;

        // Bucle per assegurar la generaci√≥ d'una seq√º√®ncia sense notes consecutives
        do {
            let tempNotes = [];
            let availableNotes = [...allNotesGlobal];
            
            for (let i = 0; i < numNotes; i++) {
                const randomIndex = Math.floor(Math.random() * availableNotes.length);
                const selectedNote = availableNotes[randomIndex];
                tempNotes.push(selectedNote);
                availableNotes.splice(randomIndex, 1);
            }
            
            currentNotes = tempNotes;
            validNotes = !hasConsecutiveNotes(currentNotes);

        } while (!validNotes);

        currentNotes.sort((a, b) => {
            const aPos = NOTE_MAPPING[a.clef][a.fullNote];
            const bPos = NOTE_MAPPING[b.clef][b.fullNote];
            return bPos - aPos;
        });

        drawNotes(currentNotes);
        
        feedbackArea.textContent = `Introdueix la nota m√©s greu. Hi ha ${numNotes} notes.`;
        noteButtons.forEach(b => b.disabled = false);
        nextButton.classList.add('hidden');
        noteIndex = 0;

        if (totalQuestions < MAX_QUESTIONS) {
            totalQuestions++;
            totalQuestionsDisplay.textContent = totalQuestions;
        }
    }
    
    function handleNoteSelection(note) {
        if (noteIndex < currentNotes.length) {
            const currentCorrectNote = currentNotes[noteIndex].fullNote.charAt(0);
            if (note === currentCorrectNote) {
                // Reprodueix so correcte
                playSound('correcte.mp3');
                feedbackArea.style.color = correctColor;
                if (noteIndex === currentNotes.length - 1) {
                    feedbackArea.textContent = `Correcte! L'acord ha estat completat.`;
                } else {
                    feedbackArea.textContent = `Correcte! Ara introdueix la seg√ºent nota (de greu a agut).`;
                }
                noteIndex++;
                if (noteIndex === currentNotes.length) {
                    checkAnswer();
                }
            } else {
                // Reprodueix so d'error
                playSound('error.mp3');
                feedbackArea.style.color = incorrectColor;
                feedbackArea.textContent = `Incorrecte. La nota correcta era ${currentCorrectNote}.`;
                checkAnswer();
            }
        }
    }

    function checkAnswer() {
        if (noteIndex === currentNotes.length) {
            feedbackArea.style.color = correctColor;
            feedbackArea.textContent = `Correcte! Has encertat totes les ${currentDifficulty} notes.`;
            score++;
        } else {
            feedbackArea.style.color = incorrectColor;
            feedbackArea.textContent = `Incorrecte! Has fallat una nota. Les notes eren: ${currentNotes.map(n => n.fullNote.charAt(0)).join(', ')}.`;
        }
        scoreDisplay.textContent = score;
        noteButtons.forEach(b => b.disabled = true);
        nextButton.classList.remove('hidden');

        if (totalQuestions === MAX_QUESTIONS) {
            nextButton.textContent = "Veure Puntuaci√≥ Final";
            nextButton.onclick = () => {
                gameContent.classList.add('hidden');
                finalScoreScreen.classList.remove('hidden');
                finalScoreDisplay.textContent = `${score} de ${MAX_QUESTIONS}`;
            };
        } else {
            nextButton.textContent = "Seg√ºent Repte";
            nextButton.onclick = () => generateQuestion(currentDifficulty);
        }
    }

    difficultyButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            // Reprodueix so de benvinguda
            playSound('benvinguda.mp3');
            const numNotes = parseInt(btn.dataset.level);
            difficultyScreen.classList.add('hidden');
            gameContent.classList.remove('hidden');
            score = 0;
            totalQuestions = 0;
            generateQuestion(numNotes);
        });
    });

    noteButtons.forEach(btn => btn.addEventListener('click', () => handleNoteSelection(btn.dataset.note)));

    playAgainButton.addEventListener('click', () => {
        finalScoreScreen.classList.add('hidden');
        difficultyScreen.classList.remove('hidden');
        nextButton.textContent = "Seg√ºent Repte";
        nextButton.onclick = () => generateQuestion(currentDifficulty);
    });
});
</script>
</body>
</html>
